(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{526:function(s,t,a){"use strict";a.r(t);var n=a(44),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"目标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#目标"}},[s._v("#")]),s._v(" 目标")]),s._v(" "),a("p",[s._v("当我们 push 代码到 git 仓库时，将项目部署到目标服务器上，具体步骤：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("- 基于代码仓库中的 Dockerfile 构建代码镜像\n- 将构建的代码镜像推送到我们的私有镜像仓库\n- 通过 ssh 连接目标服务器，远程执行部署指令，基于代码镜像启动容器\n")])])]),s._v(" "),a("h3",{attrs:{id:"示例代码说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#示例代码说明"}},[s._v("#")]),s._v(" 示例代码说明")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" deploy\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("TARGET_IMAGE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $REGISTRY_ADDR/maslow/ci"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("example"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("DOCKER_DRIVER")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" overlay2\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("stable\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker login "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("u $REGISTRY_USER "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p $REGISTRY_PASSWORD $REGISTRY_ADDR\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker pull $TARGET_IMAGE "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" true   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# for docker build caching")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker build "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from $TARGET_IMAGE "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tag $TARGET_IMAGE .\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker push $TARGET_IMAGE\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ubuntu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'which ssh-agent || (apt-get update -y && apt-get install openssh-client -y)'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" eval $(ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("s)\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' echo "$SERVER_SSH_PRIV_KEY" '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p ~/.ssh\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" chmod 0600 deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("add deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[[ -f /.dockerenv ]] && echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" > ~/.ssh/config'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_ADDR "docker run '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("P $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("TARGET_IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v('"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("这段 CI 脚本有两个 stage:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("- build  # 根据代码目录下的 Dockerfile 构建镜像，并 push 到镜像仓库\n- deploy # 通过 ssh 连接目标服务器，远程执行部署指令\n")])])]),a("p",[s._v("其中用到了一些预定义了一些环境变量：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("- REGISTRY_ADDR   # 私有镜像仓库的地址，例如：registry.cn-hangzhou.aliyuncs.com\n- REGISTRY_USER   # 私有镜像仓库用户名\n- REGISTRY_PASSWORD     # 私有镜像仓库密码\n- SERVER_SSH_PRIV_KEY   # 登陆目标服务器的私钥\n- SERVER_ADDR           # 目标服务器的地址\n")])])]),a("p",[s._v("预定义的环境变量并不在 "),a("code",[s._v(".gitlab-ci.yml")]),s._v(" 中定义，因为它们往往是一些敏感信息，具体的设置方式是提前在 GitLab Web 端代码仓库设置页面填写："),a("code",[s._v("Settings > CI/CD > Variables")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"参考链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),a("ul",[a("li",[s._v("GitLab Variables: https://docs.gitlab.com/ee/ci/variables/README.html#variables")]),s._v(" "),a("li",[s._v("Using SSH keys with GitLab CI/CD: https://docs.gitlab.com/ee/ci/ssh_keys/README.html")]),s._v(" "),a("li",[s._v("Building Docker images with GitLab CI/CD:\nhttps://docs.gitlab.com/ee/ci/docker/using_docker_build.html#making-docker-in-docker-builds-faster-with-docker-layer-caching")])])])}),[],!1,null,null,null);t.default=e.exports}}]);