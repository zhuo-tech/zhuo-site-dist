(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{525:function(s,t,a){"use strict";a.r(t);var n=a(44),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),a("p",[s._v("我们通常需要频繁的将生产环境(production)的数据库同步到 develop 和 staging 环境。")]),s._v(" "),a("p",[s._v("之前我们的做法是写了一个 shell 在服务器上手动运行，这个需要测试人员和开发人员拥有服务器权限，甚至是生产环境的权限，风险较大且 “不够 CI/CD 化”。")]),s._v(" "),a("p",[s._v("后来是想写一个 HTTP 服务来触发这样的数据库同步操作，增加了额外的工作开销，还要为这个服务配相应的 CI/CD，不如直接使用 GitLab CI 来完成这个工作。")]),s._v(" "),a("p",[s._v("GitLab CI Pipeline 不仅可以在用户 push 代码的时候被触发，还可以通过 HTTP 调用的形式主动触发。")]),s._v(" "),a("h2",{attrs:{id:"目标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#目标"}},[s._v("#")]),s._v(" 目标")]),s._v(" "),a("p",[s._v("开发 & 测试人员将 production 环境的数据库同步到 develop / staging 环境：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("- 无需接触服务器环境\n- 任意时间可主动进行同步（相对于计划任务而言）\n- 可指定同步某个项目相关的数据库\n- 可指定同步到某个服务器环境 ( develop / staging )\n")])])]),a("p",[s._v("预设场景：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("- 有三个数据库项目：project-a  project-b  project-c\n- 有三个服务器环境：production  develop  staging\n- 通过 GitLab CI Pipeline Triggers 来触发执行(HTTP方式)\n- 我们可任意指定同步某一个项目的 production 数据库到 develop 或 staging\n")])])]),s._v(" "),a("p",[s._v("首先，我们建了一个新的 GitLab Repo，可以叫作 "),a("code",[s._v("db-sync")]),s._v("，并开始配置其 CI Pipeline。")]),s._v(" "),a("h2",{attrs:{id:"示例代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#示例代码"}},[s._v("#")]),s._v(" 示例代码")]),s._v(" "),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# .gitlab-ci.yml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" dump\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" upload\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" restore\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $TO = dev "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export SERVER_HOST=$DEV_SERVER_HOST;fi\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $TO = stg "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export SERVER_HOST=$STG_SERVER_HOST;fi\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $PROJECT = project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("a "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export MONGO_DB=project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db;fi\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $PROJECT = project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("b "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export MONGO_DB=project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db;fi\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $PROJECT = project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export MONGO_DB=project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("db;fi\n  \n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" tmp_data\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dump_db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" mongo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dump\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" rm "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rf tmp_data "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mkdir tmp_data "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n      mongodump -h $MONGO_HOST --port=$MONGO_PORT -u $MONGO_USER\n       -p $MONGO_PASSWORD -d $MONGO_DB --out=tmp_data")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" cd tmp_data/$MONGO_DB "),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" tar "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zcvf ./../data.tar.gz ./*\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" $PROJECT\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" $TO\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("upload_db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" laogen/openssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" upload\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" eval $(ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("s)\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' echo "$SERVER_SSH_PRIV_KEY" '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p ~/.ssh\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" chmod 0600 deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("add deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[[ -f /.dockerenv ]] && echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" > ~/.ssh/config'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_HOST "rm '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rf /srv/db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data/$PROJECT/_data/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(' true"\n    '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_HOST "rm '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rf /srv/db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data/$PROJECT/data.tar.gz "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(' true"\n    '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" scp tmp_data/data.tar.gz root@$SERVER_HOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/srv/db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data/$PROJECT/data.tar.gz\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_HOST "mkdir '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p /srv/db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data/$PROJECT/_data "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(' true"\n    '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_HOST "tar zxvf /srv/db'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data/$PROJECT/data.tar.gz "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("C /srv/db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('data/$PROJECT/_data"\n  '),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" $PROJECT\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" laogen/openssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" restore\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" eval $(ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("s)\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' echo "$SERVER_SSH_PRIV_KEY" '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p ~/.ssh\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" chmod 0600 deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("add deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[[ -f /.dockerenv ]] && echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" > ~/.ssh/config'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" scp restore.sh root@$SERVER_HOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/srv/db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("bak/$PROJECT/restore.sh\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" export CONTAINER_ID='$(docker ps "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f name='$PROJECT' "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("f ancestor=bitnami/mongodb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("q)'\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_HOST "docker exec $CONTAINER_ID sh /bitnami/restore.sh"\n  '),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" $TO\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" $PROJECT\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br")])]),a("p",[s._v("这个 Pipeline 有三个 stages：")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[s._v("- dump 从 prod 数据库中把数据导出为文件\n- upload 将数据文件上传到 dev/stg 目标服务器\n- restore 通过 ssh 远程连接到目标服务器，将数据文件导入(restore)到 mongo 中\n")])])]),a("p",[s._v("其中涉及的 ssh 等操作前文具体讲过，不了解的话可移步 {% post_link gitlab-ci/example-docker-ssh-deploy GitLab CI 示例：Docker 镜像打包发布 & SSH 部署 %}。")]),s._v(" "),a("p",[s._v("这段 CI 脚本是我在实际工作中使用的，其中 mongodb 是使用 "),a("code",[s._v("bitnami/mongodb")]),s._v(" 镜像启动的，所以会有 "),a("code",[s._v("bitnami")]),s._v(" 相关的字眼，需要了解的话请查看文末的相关链接。")]),s._v(" "),a("p",[s._v("如果使用其它 "),a("code",[s._v("mongo")]),s._v(" 镜像或者其它数据库（ "),a("code",[s._v("mysql")]),s._v(" 等）需要做相应的调整，这里只是提供一个思路作为参考。")]),s._v(" "),a("p",[a("code",[s._v("restore.sh")]),s._v(" 这个文件在 git repo中，它被挂载到数据库容器中执行的：")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# restore.sh")]),s._v("\nmongorestore --drop -u "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MONGODB_USERNAME")]),s._v(" -p "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MONGODB_PASSWORD")]),s._v(" -d "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MONGODB_DATABASE")]),s._v(" /bitnami/_data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"触发同步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#触发同步"}},[s._v("#")]),s._v(" 触发同步")]),s._v(" "),a("p",[s._v("我们通过 "),a("code",[s._v("$PROJECT")]),s._v(" 来控制要同步哪个项目的数据库；\n通过 "),a("code",[s._v("$TO")]),s._v(" 控制要同步到哪个服务器环境(develop / staging)。")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 同步 project-a 项目的数据库到 dev 环境")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST -F "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("token")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("XXXXXXX "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -F "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ref")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("master -F "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"variables[TO]=dev"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -F "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"variables[PROJECT]=project-a"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    https://gitlab.com/api/v4/projects/xxxxxx/trigger/pipeline\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 同步 project-b 项目的数据库到 stg 环境")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -X POST -F "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("token")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("XXXXXXX "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -F "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ref")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("master -F "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"variables[TO]=stg"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -F "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"variables[PROJECT]=project-b"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    https://gitlab.com/api/v4/projects/xxxxxx/trigger/pipeline\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("我们通过 GitLab CI 的 HTTP 触发机制触发 Pipeline 的执行。\n其中 "),a("code",[s._v("token")]),s._v(" 和 "),a("code",[s._v("url")]),s._v(" 在 GitLab 仓库的设置页面获取 "),a("code",[s._v("Settings > CI/CD > Pipeline triggers > Add trigger")]),s._v("，该页面中有详情的使用说明。")]),s._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),a("p",[s._v("上面触发的例子是通过 "),a("code",[s._v("curl")]),s._v(" 发送请求完成的，也可以使用 Webhook 的方式，这样可以把请求链接加入到浏览器的书签中，需要同步数据库的时候，直接打开相应的书签即可快捷完成。")]),s._v(" "),a("p",[s._v("这种方式不仅可以用来同步数据库，还可以用来同步其它生产环境的数据，比如文件资源等。")]),s._v(" "),a("p",[s._v("同时，除去用来同步数据，也可用于备份数据等工作。")]),s._v(" "),a("h2",{attrs:{id:"相关链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#相关链接"}},[s._v("#")]),s._v(" 相关链接")]),s._v(" "),a("ul",[a("li",[s._v("bitnami/mongodb: https://github.com/bitnami/bitnami-docker-mongodb")]),s._v(" "),a("li",[s._v("MongoDB 备份(mongodump)与恢复(mongorestore)\nhttp://www.runoob.com/mongodb/mongodb-mongodump-mongorestore.html")])])])}),[],!1,null,null,null);t.default=e.exports}}]);