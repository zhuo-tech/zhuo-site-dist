(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{534:function(s,t,n){"use strict";n.r(t);var a=n(44),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h3",{attrs:{id:"提出问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#提出问题"}},[s._v("#")]),s._v(" 提出问题")]),s._v(" "),n("blockquote",[n("p",[s._v("了解 js 文件加载前的准备工作")])]),s._v(" "),n("p",[s._v("在《{% post_link nodejs/nodejs-src/the-main 从 main 函数开始 %}》这篇中说到了 "),n("code",[s._v("LoadEnvironment()")]),s._v(" 函数负责加载 js 代码，但并没有继续说明加载细节。")]),s._v(" "),n("p",[s._v("这篇从 "),n("code",[s._v("LoadEnvironment()")]),s._v(" 开始探究 js 代码加载的详细过程。")]),s._v(" "),n("h3",{attrs:{id:"loadenvironment"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#loadenvironment"}},[s._v("#")]),s._v(" LoadEnvironment()")]),s._v(" "),n("p",[n("code",[s._v("LoadEnvironment()")]),s._v(" 的逻辑分两部分：")]),s._v(" "),n("ol",[n("li",[s._v("加载并执行两个 js 文件："),n("code",[s._v("loaders.js")]),s._v(" "),n("code",[s._v("node.js")]),s._v("，执行后得到两个启动函数；")]),s._v(" "),n("li",[s._v("分别调用这两个启动函数：loaders_bootstrapper() 和 node_bootstrapper();")])]),s._v(" "),n("p",[s._v("这段代码比较长，我们把不影响主逻辑的代码省略掉，然后直接在代码中以注释的形式来解释：")]),s._v(" "),n("div",{staticClass:"language-cpp line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-cpp"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LoadEnvironment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Environment"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n  \n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/************************************************************/")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**** 第一步.加载并执行两个 js 文件：`loaders.js` `node.js`****/")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/************************************************************/")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// The bootstrapper scripts are lib/internal/bootstrap/loaders.js and")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lib/internal/bootstrap/node.js, each included as a static C string")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// defined in node_javascript.h, generated in node_javascript.cc by")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// node_js2c.")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 这两个 js 文件在 node 构建过程中就被转换成了 C++ 代码，即以 C++ 字符串的")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 形式存在于 C++ 代码中，根据这个文件名就可以直接获取相应的 js 代码字符串；")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// loaders.js 的文件名")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("String"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" loaders_name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("FIXED_ONE_BYTE_STRING")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("isolate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"internal/bootstrap/loaders.js"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行 loaders.js 得到函数： `loaders_bootstrapper`")]),s._v("\n  MaybeLocal"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Function"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" loaders_bootstrapper "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetBootstrapper")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("LoadersBootstrapperSource")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" loaders_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// node.js 文件名")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("String"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" node_name "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("FIXED_ONE_BYTE_STRING")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("isolate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"internal/bootstrap/node.js"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 执行 loaders.js 得到函数： `loaders_bootstrapper`")]),s._v("\n  MaybeLocal"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Function"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" node_bootstrapper "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetBootstrapper")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NodeBootstrapperSource")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" node_name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 上面代码中：LoadersBootstrapperSource() & NodeBootstrapperSource() 是")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 在 /src/node_javascript.h 头文件中声明的，node 源码中并没有它们的具体实现，")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 它们的实现代码是在 node 本身构建过程中生成的；")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 至于 GetBootstrapper()，它的作用是编译&执行 js 代码，返回执行结果。")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("loaders_bootstrapper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("IsEmpty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" node_bootstrapper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("IsEmpty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Object"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" global "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("context")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Global")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Expose the global object as a property on itself")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (Allows you to set stuff on `global` from anywhere in JavaScript.)")]),s._v("\n  global"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("Set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("FIXED_ONE_BYTE_STRING")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("isolate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"global"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" global"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*************************************************************************/")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* 第二步.分别调用这两个启动函数:loaders_bootstrapper、node_bootstrapper ****/")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*************************************************************************/")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Create binding loaders")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 基于 GetBinding() 函数模板 创建 get_binding_fn 函数")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Function"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" get_binding_fn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewFunctionTemplate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GetBinding"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetFunction")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("context")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLocalChecked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 基于 GetLinkedBinding() 函数模板 创建 get_linked_binding_fn 函数")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Function"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" get_linked_binding_fn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewFunctionTemplate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GetLinkedBinding"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetFunction")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("context")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLocalChecked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 基于 GetInternalBinding() 函数模板 创建 get_internal_binding_fn 函数")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Function"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" get_internal_binding_fn "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n      env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("NewFunctionTemplate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("GetInternalBinding"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetFunction")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("context")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLocalChecked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 上面三个函数会作为 调用 loaders_bootstrapper() 时的参数。")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Value"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" loaders_bootstrapper_args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("process_object")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    get_binding_fn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    get_linked_binding_fn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    get_internal_binding_fn"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Boolean")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("New")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("isolate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                 env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("options")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("debug_options"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("break_node_first_line"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// loaders_bootstrapper() 调用结果将保存在这个变量，")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 接下来，它将被作为参数传给另一个启动函数：node_bootstrapper()")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Value"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bootstrapped_loaders"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 调用启动函数 loaders_bootstrapper()")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ExecuteBootstrapper")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" loaders_bootstrapper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLocalChecked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                           "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("arraysize")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("loaders_bootstrapper_args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                           loaders_bootstrapper_args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                           "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("bootstrapped_loaders"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Bootstrap Node.js")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Object"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bootstrapper "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Object")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("::")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("New")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("isolate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("SetupBootstrapObject")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bootstrapper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Value"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" bootstrapped_node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  Local"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Value"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" node_bootstrapper_args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    env"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("process_object")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    bootstrapper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    bootstrapped_loaders\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 调用启动函数 loaders_bootstrapper()")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ExecuteBootstrapper")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" node_bootstrapper"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ToLocalChecked")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                           "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("arraysize")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("node_bootstrapper_args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                           node_bootstrapper_args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                           "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("bootstrapped_node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br")])]),n("h3",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[n("code",[s._v("LoadEnvironment()")]),s._v(" 主要是调用了两个 "),n("code",[s._v("启动函数(Bootstrapper)")])]),s._v(" "),n("ul",[n("li",[s._v("loaders_bootstrapper()")]),s._v(" "),n("li",[s._v("node_bootstrapper()")])]),s._v(" "),n("p",[s._v("其中 loaders_bootstrapper() 主要实现了一个简单的模块加载机制名为 "),n("code",[s._v("NativeModule")]),s._v("，主要用于加载内部模块的，会在 node_bootstrapper() 中用到；")]),s._v(" "),n("p",[s._v("而在 node_bootstrapper() 则加载并执行了用户的 js 文件（也就是通常的 app.js 或 index.js)。")]),s._v(" "),n("p",[s._v("这两个启动函数分别定义在 "),n("code",[s._v("/lib/internal/bootstrap/loaders.js")]),s._v(" 和 "),n("code",[s._v("/lib/internal/bootstrap/node.js")]),s._v(" 文件中；")]),s._v(" "),n("p",[s._v("接下来的两篇文，会分别对这两个文件进行详细的探究，弄清楚 js 文件加载执行的细节；")])])}),[],!1,null,null,null);t.default=e.exports}}]);