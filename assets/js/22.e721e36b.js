(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{528:function(s,t,a){"use strict";a.r(t);var n=a(44),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),a("p",[s._v("Web 前端的应用需要在 node 环境下安装依赖和构建，但是发布一般又是用 nginx 镜像，我们既不想在 node 容器里安装 nginx，也不想在 nginx 容器里安装 node；")]),s._v(" "),a("h2",{attrs:{id:"tl-dr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tl-dr"}},[s._v("#")]),s._v(" TL;DR")]),s._v(" "),a("p",[s._v("所以，我们先在一个 node 容器中 build 应用，利用 GitLab CI Cache 机制，将构建后的目标文件（通常是 dist 文件夹）缓存，以便在发布阶段 (release stage) 可以使用。")]),s._v(" "),a("p",[s._v("这里我所谓的 release 是指发布 docker image ，所以需要一个 Dockerfile，并且是以 nginx image 为基础镜像构建的。")]),s._v(" "),a("p",[s._v("我这里是部署到 swarm 集群上，所以会首先把 "),a("code",[s._v("docker-stack.yml")]),s._v(" 文件 scp 到目标服务器上。")]),s._v(" "),a("h2",{attrs:{id:"例说"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#例说"}},[s._v("#")]),s._v(" 例说")]),s._v(" "),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Dockerfile")]),s._v("\nFROM bitnami"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\nCOPY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("dist "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("app\nEXPOSE "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("div",{staticClass:"language-yml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# .gitlab-ci.yml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" release\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" deploy\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" node_modules/\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" dist/\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("before_script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $CI_COMMIT_REF_NAME = master "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export SERVER_HOST=$DEV_SERVER_HOST;fi\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $CI_COMMIT_REF_NAME = prod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export SERVER_HOST=$PROD_SERVER_HOST;fi\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $CI_COMMIT_REF_NAME = master "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export BUILD_VERSION=dev;fi\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" if "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" $CI_COMMIT_REF_NAME = prod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(";then export BUILD_VERSION=prod;fi\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("CONTAINER_IMAGE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $REGISTRY_ADDR/$REGISTRY_NAMESPACE/$CI_PROJECT_NAME\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("CONTAINER_IMAGE_VERSION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${CI_COMMIT_REF_NAME}_latest"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("CONTAINER_IMAGE_VERSION_HASH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHA}"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("DOCKER_DRIVER")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" overlay2\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm install\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" npm run build"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$BUILD_VERSION\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("release")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("dind\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" release\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ls "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("lh dist\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker login "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("u $REGISTRY_USER "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p $REGISTRY_PASSWORD $REGISTRY_ADDR\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker pull $CONTAINER_IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$CONTAINER_IMAGE_VERSION "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker build "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("from $CONTAINER_IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$CONTAINER_IMAGE_VERSION "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tag $CONTAINER_IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$CONTAINER_IMAGE_VERSION_HASH "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tag $CONTAINER_IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$CONTAINER_IMAGE_VERSION .\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker push $CONTAINER_IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$CONTAINER_IMAGE_VERSION\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" docker push $CONTAINER_IMAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$CONTAINER_IMAGE_VERSION_HASH\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" laogen/openssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" eval $(ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("s)\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' echo "$SERVER_SSH_PRIV_KEY" '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("p ~/.ssh\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" chmod 0600 deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("add deploy.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'[[ -f /.dockerenv ]] && echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" > ~/.ssh/config'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" scp docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stack.$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("BUILD_VERSION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(".yml root@$SERVER_HOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("/srv/web/docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stack.yml\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_HOST "docker login '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("u $REGISTRY_USER "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('p $REGISTRY_PASSWORD $REGISTRY_ADDR"\n    '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(' ssh root@$SERVER_HOST "cd /srv/web '),a("span",{pre:!0,attrs:{class:"token important"}},[s._v("&&")]),s._v(" docker stack deploy "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("stack.yml ProjectName "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("with"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("registry"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('auth"\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br")])]),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),a("p",[s._v("这个例子是从实际工作项目中略删减得来的，更完整综合一些。")]),s._v(" "),a("p",[s._v("这个 Pipeline 一共三个阶段：")]),s._v(" "),a("ul",[a("li",[s._v("build   # 构建前端项目")]),s._v(" "),a("li",[s._v("release # 发布 Docker 镜像")]),s._v(" "),a("li",[s._v("deploy  # 部署到 Swarm 上")])]),s._v(" "),a("p",[s._v("在 build 阶段完成后，将 build 的结果 "),a("code",[s._v("dist")]),s._v(" 缓存起来，这样到 realse 阶段时，就可以把它们打包到镜像里了，然后 push 到镜像仓库；")]),s._v(" "),a("p",[s._v("deploy 阶段就是 ssh 连接远程执行命令部署，与之前不同的是，这次是部署在 swarm 上，我们先将 "),a("code",[s._v("docker-stack.yml")]),s._v(" 上传到目标服务器，然后远程执行部署指令，这块没什么可说的。")])])}),[],!1,null,null,null);t.default=e.exports}}]);